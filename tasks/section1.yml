---
# tasks file for ansible-cis-ubuntu-2204

# ------------------------------------------------------------------------------

- name: "SECTION1 | 1.1.1.1 | Ensure cramfs kernel module is not available"
  when:
    - cis_ubuntu2204_rule_1_1_1_1
  tags:
    - rule_1_1_1
    - server_l1
    - workstation_l1
  block:
    - name: >
        SECTION1 | 1.1.1.1 | Ensure cramfs kernel module is not available | setting module and deny listing
      ansible.builtin.lineinfile:
        dest: /etc/modprobe.d/cis.conf
        regexp: "{{ item.reg }}"
        line: "{{ item.line }}"
        state: present
        create: true
        owner: "{{ cis_ubuntu2204_section1_owner_default }}"
        group: "{{ cis_ubuntu2204_section1_group_default }}"
        mode: "{{ cis_ubuntu2204_section1_mode_default }}"
      with_items:
        - reg: '{{ cis_ubuntu2204_regex_base_search }}install cramfs(\s|$)'
          line: "install cramfs /bin/false"
        - reg: "{{ cis_ubuntu2204_regex_base_search }}blacklist cramfs$"
          line: "blacklist cramfs"
    - name: >
        SECTION1 | 1.1.1.1 | Ensure cramfs kernel module is not available | unloading module
      community.general.modprobe:
        name: cramfs
        state: absent
      when: ansible_virtualization_type != "docker"

- name: "SECTION1 | 1.1.1.2 | Ensure freevxfs kernel module is not available"
  when:
    - cis_ubuntu2204_rule_1_1_1_2
  tags:
    - rule_1_1_1
    - server_l1
    - workstation_l1
  block:
    - name: >
        SECTION1 | 1.1.1.2 | Ensure freevxfs kernel module is not available | setting module and deny listing
      ansible.builtin.lineinfile:
        dest: /etc/modprobe.d/cis.conf
        regexp: "{{ item.reg }}"
        line: "{{ item.line }}"
        state: present
        create: true
        owner: "{{ cis_ubuntu2204_section1_owner_default }}"
        group: "{{ cis_ubuntu2204_section1_group_default }}"
        mode: "{{ cis_ubuntu2204_section1_mode_default }}"
      with_items:
        - reg: '{{ cis_ubuntu2204_regex_base_search }}install freevxfs(\s|$)'
          line: "install freevxfs /bin/false"
        - reg: "{{ cis_ubuntu2204_regex_base_search }}blacklist freevxfs$"
          line: "blacklist freevxfs"
    - name: >
        SECTION1 | 1.1.1.2 | Ensure freevxfs kernel module is not available | unloading module
      community.general.modprobe:
        name: freevxfs
        state: absent
      when: ansible_virtualization_type != "docker"

- name: "SECTION1 | 1.1.1.3 | Ensure hfs kernel module is not available"
  when:
    - cis_ubuntu2204_rule_1_1_1_3
  tags:
    - rule_1_1_1
    - server_l1
    - workstation_l1
  block:
    - name: >
        SECTION1 | 1.1.1.3 | Ensure hfs kernel module is not available | setting module and deny listing
      ansible.builtin.lineinfile:
        dest: /etc/modprobe.d/cis.conf
        regexp: "{{ item.reg }}"
        line: "{{ item.line }}"
        state: present
        create: true
        owner: "{{ cis_ubuntu2204_section1_owner_default }}"
        group: "{{ cis_ubuntu2204_section1_group_default }}"
        mode: "{{ cis_ubuntu2204_section1_mode_default }}"
      with_items:
        - reg: '{{ cis_ubuntu2204_regex_base_search }}install hfs(\s|$)'
          line: "install hfs /bin/false"
        - reg: "{{ cis_ubuntu2204_regex_base_search }}blacklist hfs$"
          line: "blacklist hfs"
    - name: >
        SECTION1 | 1.1.1.3 | Ensure hfs kernel module is not available | unloading module
      community.general.modprobe:
        name: hfs
        state: absent
      when: ansible_virtualization_type != "docker"

- name: "SECTION1 | 1.1.1.4 | Ensure hfsplus kernel module is not available"
  when:
    - cis_ubuntu2204_rule_1_1_1_4
  tags:
    - rule_1_1_1
    - server_l1
    - workstation_l1
  block:
    - name: >
        SECTION1 | 1.1.1.4 | Ensure hfsplus kernel module is not available | setting module and deny listing
      ansible.builtin.lineinfile:
        dest: /etc/modprobe.d/cis.conf
        regexp: "{{ item.reg }}"
        line: "{{ item.line }}"
        state: present
        create: true
        owner: "{{ cis_ubuntu2204_section1_owner_default }}"
        group: "{{ cis_ubuntu2204_section1_group_default }}"
        mode: "{{ cis_ubuntu2204_section1_mode_default }}"
      with_items:
        - reg: '{{ cis_ubuntu2204_regex_base_search }}install hfsplus(\s|$)'
          line: "install hfsplus /bin/false"
        - reg: "{{ cis_ubuntu2204_regex_base_search }}blacklist hfsplus$"
          line: "blacklist hfsplus"
    - name: >
        SECTION1 | 1.1.1.4 | Ensure hfsplus kernel module is not available | unloading module
      community.general.modprobe:
        name: hfsplus
        state: absent
      when: ansible_virtualization_type != "docker"

- name: "SECTION1 | 1.1.1.5 | Ensure jffs2 kernel module is not available"
  when:
    - cis_ubuntu2204_rule_1_1_1_5
  tags:
    - rule_1_1_1
    - server_l1
    - workstation_l1
  block:
    - name: >
        SECTION1 | 1.1.1.5 | Ensure jffs2 kernel module is not available | setting module and deny listing
      ansible.builtin.lineinfile:
        dest: /etc/modprobe.d/cis.conf
        regexp: "{{ item.reg }}"
        line: "{{ item.line }}"
        state: present
        create: true
        owner: "{{ cis_ubuntu2204_section1_owner_default }}"
        group: "{{ cis_ubuntu2204_section1_group_default }}"
        mode: "{{ cis_ubuntu2204_section1_mode_default }}"
      with_items:
        - reg: '{{ cis_ubuntu2204_regex_base_search }}install jffs2(\s|$)'
          line: "install jffs2 /bin/false"
        - reg: "{{ cis_ubuntu2204_regex_base_search }}blacklist jffs2$"
          line: "blacklist jffs2"
    - name: >
        SECTION1 | 1.1.1.5 | Ensure jffs2 kernel module is not available | unloading module
      community.general.modprobe:
        name: jffs2
        state: absent
      when: ansible_virtualization_type != "docker"

- name: "SECTION1 | 1.1.1.6 | Ensure overlay kernel module is not available"
  when:
    - cis_ubuntu2204_rule_1_1_1_6
  tags:
    - rule_1_1_1
    - server_l2
    - workstation_l2
  block:
    - name: >
        SECTION1 | 1.1.1.6 | Ensure overlay kernel module is not available | setting module and deny listing
      ansible.builtin.lineinfile:
        dest: /etc/modprobe.d/cis.conf
        regexp: "{{ item.reg }}"
        line: "{{ item.line }}"
        state: present
        create: true
        owner: "{{ cis_ubuntu2204_section1_owner_default }}"
        group: "{{ cis_ubuntu2204_section1_group_default }}"
        mode: "{{ cis_ubuntu2204_section1_mode_default }}"
      with_items:
        - reg: '{{ cis_ubuntu2204_regex_base_search }}install overlay(\s|$)'
          line: "install overlay /bin/false"
        - reg: "{{ cis_ubuntu2204_regex_base_search }}blacklist overlay$"
          line: "blacklist overlay"
    - name: >
        SECTION1 | 1.1.1.6 | Ensure overlay kernel module is not available | unloading module
      community.general.modprobe:
        name: overlay
        state: absent
      when: ansible_virtualization_type != "docker"

- name: "SECTION1 | 1.1.1.7 | Ensure squashfs kernel module is not available"
  when:
    - cis_ubuntu2204_rule_1_1_1_7
  tags:
    - rule_1_1_1
    - server_l2
    - workstation_l2
  block:
    - name: >
        SECTION1 | 1.1.1.7 | Ensure squashfs kernel module is not available | setting module and deny listing
      ansible.builtin.lineinfile:
        dest: /etc/modprobe.d/cis.conf
        regexp: "{{ item.reg }}"
        line: "{{ item.line }}"
        state: present
        create: true
        owner: "{{ cis_ubuntu2204_section1_owner_default }}"
        group: "{{ cis_ubuntu2204_section1_group_default }}"
        mode: "{{ cis_ubuntu2204_section1_mode_default }}"
      with_items:
        - reg: '{{ cis_ubuntu2204_regex_base_search }}install squashfs(\s|$)'
          line: "install squashfs /bin/false"
        - reg: "{{ cis_ubuntu2204_regex_base_search }}blacklist squashfs$"
          line: "blacklist squashfs"

- name: "SECTION1 | 1.1.1.8 | Ensure udf kernel module is not available"
  when:
    - cis_ubuntu2204_rule_1_1_1_8
  tags:
    - rule_1_1_1
    - server_l2
    - workstation_l2
  block:
    - name: >
        SECTION1 | 1.1.1.8 | Ensure udf kernel module is not available | setting module and deny listing
      ansible.builtin.lineinfile:
        dest: /etc/modprobe.d/cis.conf
        regexp: "{{ item.reg }}"
        line: "{{ item.line }}"
        state: present
        create: true
        owner: "{{ cis_ubuntu2204_section1_owner_default }}"
        group: "{{ cis_ubuntu2204_section1_group_default }}"
        mode: "{{ cis_ubuntu2204_section1_mode_default }}"
      with_items:
        - reg: '{{ cis_ubuntu2204_regex_base_search }}install udf(\s|$)'
          line: "install udf /bin/false"
        - reg: "{{ cis_ubuntu2204_regex_base_search }}blacklist udf$"
          line: "blacklist udf"
    - name: >
        SECTION1 | 1.1.1.8 | Ensure udf kernel module is not available | unloading module
      community.general.modprobe:
        name: udf
        state: absent
      when: ansible_virtualization_type != "docker"

- name: "SECTION1 | 1.1.1.9 | Ensure usb-storage kernel module is not available"
  when:
    - cis_ubuntu2204_rule_1_1_1_9
  tags:
    - rule_1_1_1
    - server_l2
    - workstation_l2
  block:
    - name: >
        SECTION1 | 1.1.1.9 | Ensure usb-storage kernel module is not available | setting module and deny listing
      ansible.builtin.lineinfile:
        dest: /etc/modprobe.d/cis.conf
        regexp: "{{ item.reg }}"
        line: "{{ item.line }}"
        state: present
        create: true
        owner: "{{ cis_ubuntu2204_section1_owner_default }}"
        group: "{{ cis_ubuntu2204_section1_group_default }}"
        mode: "{{ cis_ubuntu2204_section1_mode_default }}"
      with_items:
        - reg: '{{ cis_ubuntu2204_regex_base_search }}install usb-storage(\s|$)'
          line: "install usb-storage /bin/false"
        - reg: "{{ cis_ubuntu2204_regex_base_search }}blacklist usb-storage$"
          line: "blacklist usb-storage"
    - name: >
        SECTION1 | 1.1.1.9 | Ensure usb-storage kernel module is not available | unloading module
      community.general.modprobe:
        name: usb-storage
        state: absent
      when: ansible_virtualization_type != "docker"

- name: "SECTION1 | 1.1.1.10 | Ensure unused filesystems kernel modules are not available"
  when:
    - cis_ubuntu2204_rule_1_1_1_10
  tags:
    - rule_1_1_1
    - server_l2
    - workstation_l2
  block:
    - name: >
        SECTION1 | 1.1.1.10 | Ensure unused filesystems kernel modules are not available | find mounted filesystems
      ansible.builtin.shell: >
        set -o pipefail && findmnt -knD | awk '{print $2}' | sort -u
      register: cis_ubuntu2204_mounted_filesystems
      args:
        executable: "{{ cis_ubuntu2204_shell_executable }}"
      changed_when: false

    - name: >
        SECTION1 | 1.1.1.10 | Ensure unused filesystems kernel modules are not available | list available filesystem kernel modules
      ansible.builtin.find:
        paths: /lib/modules/{{ ansible_kernel }}/kernel/fs
        recurse: false
        file_type: directory
      register: cis_ubuntu2204_available_fs_modules

    - name: >
        SECTION1 | 1.1.1.10 | Ensure unused filesystems kernel modules are not available | check and unload loaded vulnerable filesystems
      ansible.builtin.include_tasks: section1-1_1_1_10.yml
      loop: "{{ cis_ubuntu2204_available_fs_modules.files | map(attribute='path') | map('basename') }}"
      loop_control:
        loop_var: cis_ubuntu2204_fs_module_file
      when:
        - cis_ubuntu2204_fs_module_file in cis_ubuntu2204_fs_known_vulnerable
        - cis_ubuntu2204_fs_module_file not in cis_ubuntu2204_fs_ignored

- name: "SECTION1 | 1.1.1.11 | Ensure firewire-core kernel module is not available"
  when:
    - cis_ubuntu2204_rule_1_1_1_11
  tags:
    - rule_1_1_1
    - server_l2
    - workstation_l2
  block:
    - name: >
        SECTION1 | 1.1.1.11 | Ensure firewire-core kernel module is not available | setting module and deny listing
      ansible.builtin.lineinfile:
        dest: /etc/modprobe.d/cis.conf
        regexp: "{{ item.reg }}"
        line: "{{ item.line }}"
        state: present
        create: true
        owner: "{{ cis_ubuntu2204_section1_owner_default }}"
        group: "{{ cis_ubuntu2204_section1_group_default }}"
        mode: "{{ cis_ubuntu2204_section1_mode_default }}"
      with_items:
        - reg: '{{ cis_ubuntu2204_regex_base_search }}install firewire_core(\s|$)'
          line: "install firewire_core /bin/false"
        - reg: "{{ cis_ubuntu2204_regex_base_search }}blacklist firewire_core$"
          line: "blacklist firewire_core"
    - name: >
        SECTION1 | 1.1.1.11 | Ensure firewire-core kernel module is not available | unloading module
      community.general.modprobe:
        name: firewire_core
        state: absent
      when: ansible_virtualization_type != "docker"

# ------------------------------------------------------------------------------

- name: |
    SECTION1 | 1.1.2.1   | Configure /tmp
    SECTION1 | 1.1.2.1.1 | Ensure /tmp is tmpfs or a separate partition
    SECTION1 | 1.1.2.1.2 | Ensure nodev option set on /tmp partition
    SECTION1 | 1.1.2.1.3 | Ensure nosuid option set on /tmp partition
    SECTION1 | 1.1.2.1.4 | Ensure noexec option set on /tmp partition
  ansible.builtin.template:
    src: system/tmp.mount.j2
    dest: /etc/systemd/system/tmp.mount
    owner: "{{ cis_ubuntu2204_section1_owner_default }}"
    group: "{{ cis_ubuntu2204_section1_group_default }}"
    mode: "{{ cis_ubuntu2204_section1_mode_default }}"
  notify: Systemd restart and enable tmp.mount
  when:
    - cis_ubuntu2204_rule_1_1_2_1
  tags:
    - rule_1_1_2_1
    - server_l1
    - workstation_l1

# ------------------------------------------------------------------------------

- name: |
    SECTION1 | 1.1.2.2   | Configure /dev/shm
    SECTION1 | 1.1.2.2.1 | Ensure /dev/shm is tmpfs or a separate partition
    SECTION1 | 1.1.2.2.2 | Ensure nodev option set on /dev/shm partition
    SECTION1 | 1.1.2.2.3 | Ensure nosuid option set on /dev/shm partition
    SECTION1 | 1.1.2.2.4 | Ensure noexec option set on /dev/shm partition
  ansible.posix.mount:
    name: /dev/shm
    src: tmpfs
    state: mounted
    fstype: tmpfs
    opts: "defaults,rw,relatime,size=2G,nodev,nosuid,noexec"
  when:
    - cis_ubuntu2204_rule_1_1_2_2
  tags:
    - rule_1_1_2_2
    - server_l1
    - workstation_l1

# ------------------------------------------------------------------------------

# - name: |
#     SECTION1 | 1.1.2.3   | Configure /home
#     SECTION1 | 1.1.2.3.1 | Ensure separate partition exists for /home
#     SECTION1 | 1.1.2.3.2 | Ensure nodev option set on /home partition
#     SECTION1 | 1.1.2.3.3 | Ensure nosuid option set on /home partition
#   ansible.builtin.template:
#     src: system/home.mount.j2
#     dest: /etc/systemd/system/home.mount
#     owner: "{{ cis_ubuntu2204_section1_owner_default }}"
#     group: "{{ cis_ubuntu2204_section1_group_default }}"
#     mode: "{{ cis_ubuntu2204_section1_mode_default }}"
#   notify:
#     - systemd restart and enable home.mount
#   when:
#     - cis_ubuntu2204_rule_1_1_2_3
#   tags:
#     - rule_1_1_2_3
#     - server_l2
#     - workstation_l2

# ------------------------------------------------------------------------------

# - name: |
#     SECTION1 | 1.1.2.4   | Configure /var
#     SECTION1 | 1.1.2.4.1 | Ensure separate partition exists for /var
#     SECTION1 | 1.1.2.4.2 | Ensure nodev option set on /var partition
#     SECTION1 | 1.1.2.4.3 | Ensure nosuid option set on /var partition
#   ansible.builtin.template:
#     src: system/var.mount.j2
#     dest: /etc/systemd/system/var.mount
#     owner: "{{ cis_ubuntu2204_section1_owner_default }}"
#     group: "{{ cis_ubuntu2204_section1_group_default }}"
#     mode: "{{ cis_ubuntu2204_section1_mode_default }}"
#   notify:
#     - systemd restart and enable var.mount
#   when:
#     - cis_ubuntu2204_rule_1_1_2_4
#   tags:
#     - rule_1_1_2_4
#     - server_l2
#     - workstation_l2

# # ------------------------------------------------------------------------------

# - name: |
#     SECTION1 | 1.1.2.5   | Configure /var/tmp
#     SECTION1 | 1.1.2.5.1 | Ensure separate partition exists for /var/tmp
#     SECTION1 | 1.1.2.5.2 | Ensure nodev option set on /var/tmp partition
#     SECTION1 | 1.1.2.5.3 | Ensure nosuid option set on /var/tmp partition
#     SECTION1 | 1.1.2.5.4 | Ensure noexec option set on /var/tmp partition
#   ansible.builtin.template:
#     src: system/var.tmp.mount.j2
#     dest: /etc/systemd/system/var.tmp.mount
#     owner: "{{ cis_ubuntu2204_section1_owner_default }}"
#     group: "{{ cis_ubuntu2204_section1_group_default }}"
#     mode: "{{ cis_ubuntu2204_section1_mode_default }}"
#   notify:
#     - systemd restart and enable var.tmp.mount
#   when:
#     - cis_ubuntu2204_rule_1_1_2_5
#   tags:
#     - rule_1_1_2_5
#     - server_l2
#     - workstation_l2

# # ------------------------------------------------------------------------------

# - name: |
#     SECTION1 | 1.1.2.6   | Configure /var/log
#     SECTION1 | 1.1.2.6.1 | Ensure separate partition exists for /var/log
#     SECTION1 | 1.1.2.6.2 | Ensure nodev option set on /var/log partition
#     SECTION1 | 1.1.2.6.3 | Ensure nosuid option set on /var/log partition
#     SECTION1 | 1.1.2.6.4 | Ensure noexec option set on /var/log partition
#   ansible.builtin.template:
#     src: system/var.log.mount.j2
#     dest: /etc/systemd/system/var.log.mount
#     owner: "{{ cis_ubuntu2204_section1_owner_default }}"
#     group: "{{ cis_ubuntu2204_section1_group_default }}"
#     mode: "{{ cis_ubuntu2204_section1_mode_default }}"
#   notify:
#     - systemd restart and enable var.log.mount
#   when:
#     - cis_ubuntu2204_rule_1_1_2_6
#   tags:
#     - rule_1_1_2_6
#     - server_l2
#     - workstation_l2

# # ------------------------------------------------------------------------------

# - name: |
#     SECTION1 | 1.1.2.7 | Configure /var/log/audit
#     SECTION1 | 1.1.2.7.1 | Ensure separate partition exists for /var/log/audit
#     SECTION1 | 1.1.2.7.2 | Ensure nodev option set on /var/log/audit partition
#     SECTION1 | 1.1.2.7.3 | Ensure nosuid option set on /var/log/audit partition
#     SECTION1 | 1.1.2.7.4 | Ensure noexec option set on /var/log/audit partition
#   ansible.builtin.template:
#     src: system/var.log.audit.mount.j2
#     dest: /etc/systemd/system/var.log.audit.mount
#     owner: "{{ cis_ubuntu2204_section1_owner_default }}"
#     group: "{{ cis_ubuntu2204_section1_group_default }}"
#     mode: "{{ cis_ubuntu2204_section1_mode_default }}"
#   notify:
#     - systemd restart and enable var.log.audit.mount
#   when:
#     - cis_ubuntu2204_rule_1_1_2_7
#   tags:
#     - rule_1_1_2_7
#     - server_l2
#     - workstation_l2

# ------------------------------------------------------------------------------

- name: "SECTION1 | 1.2.1.1 | Ensure GPG keys are configured"
  when:
    - cis_ubuntu2204_rule_1_2_1_1
  tags:
    - rule_1_2_1
    - server_l1
    - workstation_l1
  block:
    - name: "SECTION1 | 1.2.1.1 | Ensure GPG keys are configured | get info"
      ansible.builtin.shell: apt-key list
      args:
        executable: "{{ cis_ubuntu2204_shell_executable }}"
      register: cis_ubuntu2204_apt_key_list
      changed_when: false
      failed_when: false
      check_mode: false
    - name: "SECTION1 | 1.2.1.1 | Ensure GPG keys are configured | print info"
      ansible.builtin.debug:
        msg: |
          #############################################################################################
          Ensure GPG keys are configured.
          #############################################################################################
          {{ cis_ubuntu2204_apt_key_list.stdout_lines | join(cis_ubuntu2204_print_info_join_by) }}
          #############################################################################################
      when:
        - cis_ubuntu2204_apt_key_list.stdout_lines is defined
        - cis_ubuntu2204_apt_key_list.stdout_lines | length > 0

- name: "SECTION1 | 1.2.1.2 | Ensure package manager repositories are configured"
  when:
    - cis_ubuntu2204_rule_1_2_1_2
  tags:
    - rule_1_2_1
    - server_l1
    - workstation_l1
  block:
    - name: "SECTION1 | 1.2.1.2 | Ensure package manager repositories are configured | get info"
      ansible.builtin.shell: apt-cache policy
      args:
        executable: "{{ cis_ubuntu2204_shell_executable }}"
      register: cis_ubuntu2204_apt_key_list
      changed_when: false
      failed_when: false
      check_mode: false
    - name: "SECTION1 | 1.2.1.2 | Ensure package manager repositories are configured | print info"
      ansible.builtin.debug:
        msg: |
          #############################################################################################
          Ensure package manager repositories are configured.
          #############################################################################################
          {{ cis_ubuntu2204_apt_key_list.stdout_lines | join(cis_ubuntu2204_print_info_join_by) }}
          #############################################################################################
      when:
        - cis_ubuntu2204_apt_key_list.stdout_lines is defined
        - cis_ubuntu2204_apt_key_list.stdout_lines | length > 0

# ------------------------------------------------------------------------------

- name: "SECTION1 | 1.2.2.1 | Ensure updates, patches, and additional security software are installed"
  ansible.builtin.apt:
    upgrade: dist
    force_apt_get: true
  when:
    - cis_ubuntu2204_rule_1_2_2_1
  tags:
    - rule_1_2_2
    - server_l1
    - workstation_l1

# ------------------------------------------------------------------------------

- name: "SECTION1 | 1.3.1.1 | Ensure the apparmor packages are installed"
  ansible.builtin.apt:
    name:
      - apparmor
      - apparmor-utils # installs 'aa-enforce'
    state: present
    force_apt_get: true
  notify: Restart apparmor
  when:
    - cis_ubuntu2204_rule_1_3_1_1
  tags:
    - rule_1_3_1
    - server_l1
    - workstation_l1

- name: "SECTION1 | 1.3.1.2 | Ensure AppArmor is enabled"
  when:
    - cis_ubuntu2204_rule_1_3_1_2
  tags:
    - rule_1_3_1
    - server_l1
    - workstation_l1
  block:
    - name: "SECTION1 | 1.3.1.2 | Ensure AppArmor is enabled | grub add - apparmor"
      ansible.builtin.replace:
        path: "{{ cis_ubuntu2204_default_grub_file }}"
        regexp: '^(GRUB_CMDLINE_LINUX=\"(?!.*apparmor=)[^\"]*)(\".*)'
        replace: '\1 apparmor=1\2'
      notify: Update-grub
    - name: "SECTION1 | 1.3.1.2 | Ensure AppArmor is enabled | grub replace - apparmor"
      ansible.builtin.replace:
        path: "{{ cis_ubuntu2204_default_grub_file }}"
        regexp: 'apparmor=\d+'
        replace: "apparmor=1"
      notify: Update-grub
    # - name: "SECTION1 | 1.3.1.2 | Ensure AppArmor is enabled | grub add - security"
    #   ansible.builtin.replace:
    #     path: "{{ cis_ubuntu2204_default_grub_file }}"
    #     regexp: '^(GRUB_CMDLINE_LINUX=\"(?!.*security=)[^\"]*)(\".*)'
    #     replace: '\1 security=apparmor\2'
    #   notify: Update-grub
    # - name: "SECTION1 | 1.3.1.2 | Ensure AppArmor is enabled | grub replace - security"
    #   ansible.builtin.replace:
    #     path: "{{ cis_ubuntu2204_default_grub_file }}"
    #     regexp: 'security=\w+'
    #     replace: "security=apparmor"
    #   notify: Update-grub

- name: "SECTION1 | 1.3.1.3 | Ensure all AppArmor Profiles are not disabled"
  when:
    - cis_ubuntu2204_rule_1_3_1_3
  tags:
    - rule_1_3_1
    - server_l1
    - workstation_l1
  block:
    - name: "SECTION1 | 1.3.1.3 | Ensure all AppArmor Profiles are not disabled | get status"
      ansible.builtin.command: "/usr/sbin/apparmor_status --json"
      changed_when: false
      register: cis_ubuntu2204_apparmor_json_status_1_3_1_3
    - name: "SECTION1 | 1.3.1.3 | Ensure all AppArmor Profiles are not disabled | get unconfined profiles"
      ansible.builtin.set_fact:
        cis_ubuntu2204_apparmor_update_to_complain_profiles: "{{ (cis_ubuntu2204_apparmor_json_status_1_3_1_3.stdout | from_json).profiles | dict2items | selectattr('value', 'in', ['unconfined']) | map(attribute='key') | list }}"
      when:
        - cis_ubuntu2204_apparmor_update_to_complain_profiles is not defined
        - cis_ubuntu2204_apparmor_json_status_1_3_1_3.stdout is defined
        - cis_ubuntu2204_apparmor_json_status_1_3_1_3.stdout | length > 0
    - name: "SECTION1 | 1.3.1.3 | Ensure all AppArmor Profiles are not disabled | apply unconfined into complain"
      ansible.builtin.command: "/usr/sbin/aa-complain {{ item }}"
      changed_when: false
      loop: "{{ cis_ubuntu2204_apparmor_update_to_complain_profiles }}"
      notify: Restart apparmor
      when:
        - cis_ubuntu2204_apparmor_update_to_complain_profiles is defined
        - cis_ubuntu2204_apparmor_update_to_complain_profiles | length > 0

- name: "SECTION1 | 1.3.1.4 | Ensure all AppArmor Profiles are enforcing"
  when:
    - cis_ubuntu2204_rule_1_3_1_4
  tags:
    - rule_1_3_1
    - server_l2
    - workstation_l2
  block:
    - name: "SECTION1 | 1.3.1.4 | Ensure all AppArmor Profiles are enforcing | get status"
      ansible.builtin.command: "/usr/sbin/apparmor_status --json"
      changed_when: false
      register: cis_ubuntu2204_apparmor_json_status_1_3_1_4
    - name: "SECTION1 | 1.3.1.4 | Ensure all AppArmor Profiles are enforcing | get unconfined & complain profiles"
      ansible.builtin.set_fact:
        cis_ubuntu2204_apparmor_update_to_enforce_profiles: "{{ (cis_ubuntu2204_apparmor_json_status_1_3_1_4.stdout | from_json).profiles | dict2items | selectattr('value', 'in', ['unconfined', 'complain']) | map(attribute='key') | list }}"
      when:
        - cis_ubuntu2204_apparmor_update_to_enforce_profiles is not defined
        - cis_ubuntu2204_apparmor_json_status_1_3_1_4.stdout is defined
        - cis_ubuntu2204_apparmor_json_status_1_3_1_4.stdout | length > 0
    - name: "SECTION1 | 1.3.1.4 | Ensure all AppArmor Profiles are enforcing | apply unconfined into enforce"
      ansible.builtin.command: "/usr/sbin/aa-enforce {{ item }}"
      changed_when: false
      loop: "{{ cis_ubuntu2204_apparmor_update_to_enforce_profiles }}"
      notify: Restart apparmor
      when:
        - cis_ubuntu2204_apparmor_update_to_enforce_profiles is defined
        - cis_ubuntu2204_apparmor_update_to_enforce_profiles | length > 0

# ------------------------------------------------------------------------------

- name: "SECTION1 | 1.4.1 | Ensure bootloader password is set"
  when:
    - cis_ubuntu2204_rule_1_4_1
    - cis_ubuntu2204_set_boot_pass
  tags:
    - rule_1_4
    - server_l1
    - workstation_l1
    - molecule-idempotence-notest
  block:
    - name: "SECTION1 | 1.4.1 | Ensure bootloader password is set | generate password"
      ansible.builtin.shell: |
        set -o pipefail &&
          if [ '{{ cis_ubuntu2204_bootloader_password }}' == 'random' ]; then
            PASSWORD=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c12)
          else
            PASSWORD='{{ cis_ubuntu2204_bootloader_password }}'
          fi
        echo -e "$PASSWORD\n$PASSWORD" | grub-mkpasswd-pbkdf2 --iteration-count=600000 --salt=64 | awk '/grub.pbkdf/{print$NF}'
      register: cis_ubuntu2204_grub_bootloader_password
      args:
        executable: "{{ cis_ubuntu2204_shell_executable }}"
      changed_when: false
    - name: "SECTION1 | 1.4.1 | Ensure bootloader password is set | generate config"
      ansible.builtin.copy:
        dest: /etc/grub.d/00_password
        content: "cat << EOF\nexec tail -n +2 $0\nset superusers=\"root\"\npassword_pbkdf2 root {{ cis_ubuntu2204_grub_bootloader_password.stdout }}\nEOF"
        owner: "{{ cis_ubuntu2204_section1_owner_default }}"
        group: "{{ cis_ubuntu2204_section1_group_default }}"
        mode: "{{ cis_ubuntu2204_section1_mode_etc_grub_d }}"
      notify: Generate new grub config
      when:
        - cis_ubuntu2204_grub_bootloader_password is defined
        - cis_ubuntu2204_grub_bootloader_password.stdout is defined
        - cis_ubuntu2204_grub_bootloader_password.stdout | length > 0
    - name: "SECTION1 | 1.4.1 | Ensure bootloader password is set | disable password for system boot"
      ansible.builtin.replace:
        path: /etc/grub.d/10_linux
        regexp: '--class os"'
        replace: '--class os --unrestricted"'
      notify: Generate new grub config
      when:
        - cis_ubuntu2204_disable_boot_pass

- name: "SECTION1 | 1.4.2 | Ensure access to bootloader config is configured"
  ansible.builtin.file:
    path: "{{ item.path }}"
    owner: "{{ cis_ubuntu2204_section1_owner_default }}"
    group: "{{ cis_ubuntu2204_section1_group_default }}"
    mode: "{{ cis_ubuntu2204_section1_mode_boot_grub }}"
  with_items:
    - path: /boot/grub/grub.cfg
      check: "{{ cis_grub_cfg.stat.exists }}"
    - path: /boot/grub/grub.conf
      check: "{{ cis_grub_conf.stat.exists }}"
    - path: /boot/grub/menu.lst
      check: "{{ cis_menu_lst.stat.exists }}"
  when:
    - cis_ubuntu2204_rule_1_4_2
    - item.check | bool
  tags:
    - rule_1_4
    - server_l1
    - workstation_l1

# ------------------------------------------------------------------------------

- name: "SECTION1 | 1.5.1 | Ensure randomize_va_space is configured"
  ansible.posix.sysctl:
    name: kernel.randomize_va_space
    value: "2"
    sysctl_file: "{{ cis_ubuntu2204_sysctl_file_path }}"
    sysctl_set: true
    state: present
    reload: true
    ignoreerrors: true
  when:
    - cis_ubuntu2204_rule_1_5_1
  tags:
    - rule_1_5
    - server_l1
    - workstation_l1

- name: "SECTION1 | 1.5.2 | Ensure ptrace_scope is configured"
  ansible.posix.sysctl:
    name: kernel.yama.ptrace_scope
    value: "1"
    sysctl_file: "{{ cis_ubuntu2204_sysctl_file_path }}"
    sysctl_set: true
    state: present
    reload: true
    ignoreerrors: true
  when:
    - cis_ubuntu2204_rule_1_5_2
  tags:
    - rule_1_5
    - server_l1
    - workstation_l1

- name: "SECTION1 | 1.5.3 | Ensure suid_dumpable is configured"
  ansible.posix.sysctl:
    name: fs.suid_dumpable
    value: "0"
    sysctl_file: "{{ cis_ubuntu2204_sysctl_file_path }}"
    sysctl_set: true
    state: present
    reload: true
    ignoreerrors: true
  when:
    - cis_ubuntu2204_rule_1_5_3
  tags:
    - rule_1_5
    - server_l1
    - workstation_l1

- name: "SECTION1 | 1.5.4 | Ensure core file size is configured"
  ansible.builtin.lineinfile:
    dest: /etc/security/limits.d/60-limits.conf
    regexp: '{{ cis_ubuntu2204_regex_base_search }}\*\s+hard\s+core\s+[0-9]+'
    line: "*                hard    core            0"
    state: present
    create: true
    insertbefore: "# End of file"
    owner: "{{ cis_ubuntu2204_section1_owner_default }}"
    group: "{{ cis_ubuntu2204_section1_group_default }}"
    mode: "{{ cis_ubuntu2204_section1_mode_default }}"
  when:
    - cis_ubuntu2204_rule_1_5_4
  tags:
    - rule_1_5
    - server_l1
    - workstation_l1

- name: "SECTION1 | 1.5.5 | Ensure prelink is not installed"
  when:
    - package_installed_prelink.rc == 0
    - cis_ubuntu2204_rule_1_5_5
  tags:
    - rule_1_5
    - server_l1
    - workstation_l1
  block:
    - name: "SECTION1 | 1.5.5 | Ensure prelink is not installed | restore binaries to normal"
      ansible.builtin.command: prelink -ua
      changed_when: false
    - name: "SECTION1 | 1.5.5 | Ensure prelink is not installed | uninstall"
      ansible.builtin.apt:
        name: prelink
        state: absent
        purge: true

- name: "SECTION1 | 1.5.6 | Ensure Automatic Error Reporting is configured"
  when:
    - service_status_apport.stdout in ('loadedactive','loadedinactive')
    - cis_ubuntu2204_rule_1_5_6
  tags:
    - rule_1_5
    - server_l1
    - workstation_l2
  block:
    - name: >
        SECTION1 | 1.5.6 | Ensure Automatic Error Reporting is configured | add or edit the enabled parameter to equal 0
      ansible.builtin.lineinfile:
        dest: /etc/default/apport
        regexp: "{{ cis_ubuntu2204_regex_base_search }}enabled{{ cis_ubuntu2204_regex_base_search_equals }}"
        line: "enabled=0"
        state: present
        create: true
        owner: "{{ cis_ubuntu2204_section1_owner_default }}"
        group: "{{ cis_ubuntu2204_section1_group_default }}"
        mode: "{{ cis_ubuntu2204_section1_mode_default }}"
    - name: >
        SECTION1 | 1.5.6 | Ensure Automatic Error Reporting is configured | stop and disable service
      ansible.builtin.systemd_service:
        name: apport
        daemon_reload: true
        enabled: false
        masked: true

# ------------------------------------------------------------------------------

- name: "SECTION1 | 1.6.1 | Ensure /etc/motd is configured"
  ansible.builtin.copy:
    content: |
      {{ cis_ubuntu2204_warning_banner }}

    dest: /etc/motd
    mode: "{{ cis_ubuntu2204_section1_mode_etc_issue_motd }}"
  when:
    - cis_ubuntu2204_rule_1_6_1
  tags:
    - rule_1_6
    - server_l1
    - workstation_l1

- name: "SECTION1 | 1.6.2 | Ensure /etc/issue is configured"
  ansible.builtin.copy:
    content: |
      {{ cis_ubuntu2204_warning_banner }}

    dest: /etc/issue
    mode: "{{ cis_ubuntu2204_section1_mode_etc_issue_motd }}"
  when:
    - cis_ubuntu2204_rule_1_6_2
  tags:
    - rule_1_6
    - server_l1
    - workstation_l1

- name: "SECTION1 | 1.6.3 | Ensure /etc/issue.net is configured"
  ansible.builtin.copy:
    content: |
      {{ cis_ubuntu2204_warning_banner }}

    dest: /etc/issue.net
    mode: "{{ cis_ubuntu2204_section1_mode_etc_issue_motd }}"
  when:
    - cis_ubuntu2204_rule_1_6_3
  tags:
    - rule_1_6
    - server_l1
    - workstation_l1

- name: "SECTION1 | 1.6.4 | Ensure permissions on /etc/motd are configured"
  ansible.builtin.file:
    dest: /etc/motd
    state: file
    owner: "{{ cis_ubuntu2204_section1_owner_default }}"
    group: "{{ cis_ubuntu2204_section1_group_default }}"
    mode: "{{ cis_ubuntu2204_section1_mode_etc_issue_motd }}"
  when:
    - cis_ubuntu2204_rule_1_6_4
  tags:
    - rule_1_6
    - server_l1
    - workstation_l1

- name: "SECTION1 | 1.6.5 | Ensure permissions on /etc/issue are configured"
  ansible.builtin.file:
    dest: /etc/issue
    state: file
    owner: "{{ cis_ubuntu2204_section1_owner_default }}"
    group: "{{ cis_ubuntu2204_section1_group_default }}"
    mode: "{{ cis_ubuntu2204_section1_mode_etc_issue_motd }}"
  when:
    - cis_ubuntu2204_rule_1_6_5
  tags:
    - rule_1_6
    - server_l1
    - workstation_l1

- name: "SECTION1 | 1.6.6 | Ensure permissions on /etc/issue.net are configured"
  ansible.builtin.file:
    dest: /etc/issue.net
    state: file
    owner: "{{ cis_ubuntu2204_section1_owner_default }}"
    group: "{{ cis_ubuntu2204_section1_group_default }}"
    mode: "{{ cis_ubuntu2204_section1_mode_etc_issue_motd }}"
  when:
    - cis_ubuntu2204_rule_1_6_6
  tags:
    - rule_1_6
    - server_l1
    - workstation_l1

# ------------------------------------------------------------------------------

- name: "SECTION1 | 1.7.1 | Ensure GNOME Display Manager is removed"
  ansible.builtin.apt:
    name: gdm3
    state: absent
    purge: true
  when:
    - not cis_ubuntu2204_allow_gdm_gui
    - cis_ubuntu2204_rule_1_7_1
  tags:
    - rule_1_7
    - server_l2

- name: "SECTION1 | 1.7.2-9 | create folder under '/etc/dconf/db/*', for upcoming tasks"
  when:
    - service_status_gdm3.stdout in ('loadedactive','loadedinactive')
    - cis_ubuntu2204_allow_gdm_gui
  notify: Update dconf
  tags:
    - rule_1_7
    - server_l1
    - workstation_l1
  block:
    - name: "SECTION1 | 1.7.2-3 | create folder /etc/dconf/db/gdm.d"
      ansible.builtin.file:
        path: /etc/dconf/db/gdm.d
        state: directory
        owner: "{{ cis_ubuntu2204_section1_owner_default }}"
        group: "{{ cis_ubuntu2204_section1_group_default }}"
        mode: "0755"
    - name: "SECTION1 | 1.7.4/6/8 | create folder /etc/dconf/db/local.d"
      ansible.builtin.file:
        path: /etc/dconf/db/local.d
        state: directory
        owner: "{{ cis_ubuntu2204_section1_owner_default }}"
        group: "{{ cis_ubuntu2204_section1_group_default }}"
        mode: "0755"
    - name: "SECTION1 | 1.7.5/7/9 | create folder /etc/dconf/db/local.d/locks"
      ansible.builtin.file:
        path: /etc/dconf/db/local.d/locks
        state: directory
        owner: "{{ cis_ubuntu2204_section1_owner_default }}"
        group: "{{ cis_ubuntu2204_section1_group_default }}"
        mode: "0755"

- name: "SECTION1 | 1.7.2 | Ensure GDM login banner is configured"
  when:
    - service_status_gdm3.stdout in ('loadedactive','loadedinactive')
    - cis_ubuntu2204_allow_gdm_gui
    - cis_ubuntu2204_rule_1_7_2
  notify: Update dconf
  tags:
    - rule_1_7
    - server_l1
    - workstation_l1
  block:
    - name: "SECTION1 | 1.7.2 | Ensure GDM login banner is configured | file gdm"
      ansible.builtin.template:
        src: gdm/profile-gdm.j2
        dest: /etc/dconf/profile/gdm
        owner: "{{ cis_ubuntu2204_section1_owner_default }}"
        group: "{{ cis_ubuntu2204_section1_group_default }}"
        mode: "{{ cis_ubuntu2204_section1_mode_default }}"
    - name: "SECTION1 | 1.7.2 | Ensure GDM login banner is configured | file 01-banner-message"
      ansible.builtin.template:
        src: gdm/01-banner-message.j2
        dest: /etc/dconf/db/gdm.d/01-banner-message
        owner: "{{ cis_ubuntu2204_section1_owner_default }}"
        group: "{{ cis_ubuntu2204_section1_group_default }}"
        mode: "{{ cis_ubuntu2204_section1_mode_default }}"
    - name: "SECTION1 | 1.7.2 | Ensure GDM login banner is configured | gather users"
      ansible.builtin.command: >
        awk -F: '($3 >= 1000) && ($7 != "/usr/sbin/nologin") && ($7 != "/bin/false") {print $1}' /etc/passwd
      register: cis_ubuntu2204_users_with_home
      changed_when: false
    - name: "SECTION1 | 1.7.2 | Ensure GDM login banner is configured | set gsettings banner message per use per user"
      become: true
      become_user: "{{ item }}"
      ansible.builtin.command: "dbus-run-session -- gsettings set org.gnome.login-screen banner-message-text '{{ cis_ubuntu2204_warning_banner }}'"
      register: cis_ubuntu2204_update_user_banner_message
      changed_when: cis_ubuntu2204_update_user_banner_message.rc == 0
      failed_when: false
      loop: "{{ cis_ubuntu2204_users_with_home.stdout_lines }}"
    - name: "SECTION1 | 1.7.2 | Ensure GDM login banner is configured | set gsettings activate banner message per user"
      become: true
      become_user: "{{ item }}"
      ansible.builtin.command: "dbus-run-session -- gsettings set org.gnome.login-screen banner-message-enable true"
      register: cis_ubuntu2204_activate_user_banner_message
      changed_when: cis_ubuntu2204_activate_user_banner_message.rc == 0
      failed_when: false
      loop: "{{ cis_ubuntu2204_users_with_home.stdout_lines }}"

- name: "SECTION1 | 1.7.3 | Ensure GDM disable-user-list option is enabled"
  when:
    - service_status_gdm3.stdout in ('loadedactive','loadedinactive')
    - cis_ubuntu2204_allow_gdm_gui
    - cis_ubuntu2204_rule_1_7_3
  notify: Update dconf
  tags:
    - rule_1_7
    - server_l1
    - workstation_l1
  block:
    - name: "SECTION1 | 1.7.3 | Ensure GDM disable-user-list option is enabled | file gdm"
      ansible.builtin.template:
        src: gdm/profile-gdm.j2
        dest: /etc/dconf/profile/gdm
        owner: "{{ cis_ubuntu2204_section1_owner_default }}"
        group: "{{ cis_ubuntu2204_section1_group_default }}"
        mode: "{{ cis_ubuntu2204_section1_mode_default }}"
    - name: "SECTION1 | 1.7.3 | Ensure GDM disable-user-list option is enabled | file 00-login-screen"
      ansible.builtin.template:
        src: gdm/00-login-screen.j2
        dest: /etc/dconf/db/gdm.d/00-login-screen
        owner: "{{ cis_ubuntu2204_section1_owner_default }}"
        group: "{{ cis_ubuntu2204_section1_group_default }}"
        mode: "{{ cis_ubuntu2204_section1_mode_default }}"
    - name: "SECTION1 | 1.7.3 | Ensure GDM disable-user-list option is enabled | gather users"
      ansible.builtin.command: >
        awk -F: '($3 >= 1000) && ($7 != "/usr/sbin/nologin") && ($7 != "/bin/false") {print $1}' /etc/passwd
      register: cis_ubuntu2204_users_with_home
      changed_when: false
    - name: "SECTION1 | 1.7.3 | Ensure GDM disable-user-list option is enabled | set gsettings disable user list per user"
      become: true
      become_user: "{{ item }}"
      ansible.builtin.command: "dbus-run-session -- gsettings set org.gnome.login-screen disable-user-list true"
      register: cis_ubuntu2204_disable_user_list
      changed_when: cis_ubuntu2204_disable_user_list.rc == 0
      failed_when: false
      loop: "{{ cis_ubuntu2204_users_with_home.stdout_lines }}"

- name: "SECTION1 | 1.7.4 | Ensure GDM screen locks when the user is idle"
  when:
    - service_status_gdm3.stdout in ('loadedactive','loadedinactive')
    - cis_ubuntu2204_allow_gdm_gui
    - cis_ubuntu2204_rule_1_7_4
  notify: Update dconf
  tags:
    - rule_1_7
    - server_l1
    - workstation_l1
  block:
    - name: "SECTION1 | 1.7.4 | Ensure GDM screen locks when the user is idle | file user"
      ansible.builtin.template:
        src: gdm/profile-user.j2
        dest: /etc/dconf/profile/user
        owner: "{{ cis_ubuntu2204_section1_owner_default }}"
        group: "{{ cis_ubuntu2204_section1_group_default }}"
        mode: "{{ cis_ubuntu2204_section1_mode_default }}"
    - name: "SECTION1 | 1.7.4 | Ensure GDM screen locks when the user is idle | file 00-screensaver"
      ansible.builtin.template:
        src: gdm/00-screensaver.j2
        dest: /etc/dconf/db/local.d/00-screensaver
        owner: "{{ cis_ubuntu2204_section1_owner_default }}"
        group: "{{ cis_ubuntu2204_section1_group_default }}"
        mode: "{{ cis_ubuntu2204_section1_mode_default }}"
    - name: "SECTION1 | 1.7.4 | Ensure GDM screen locks when the user is idle | gather users"
      ansible.builtin.command: >
        awk -F: '($3 >= 1000) && ($7 != "/usr/sbin/nologin") && ($7 != "/bin/false") {print $1}' /etc/passwd
      register: cis_ubuntu2204_users_with_home
      changed_when: false
    - name: "SECTION1 | 1.7.4 | Ensure GDM screen locks when the user is idle | set gsettings set screensaver lock-delay per user"
      become: true
      become_user: "{{ item }}"
      ansible.builtin.command: "dbus-run-session -- gsettings set org.gnome.desktop.screensaver lock-delay {{ cis_ubuntu2204_rule_gdm_lock_delay }}"
      register: cis_ubuntu2204_screensaver_lock_delay
      changed_when: cis_ubuntu2204_screensaver_lock_delay.rc == 0
      failed_when: false
      loop: "{{ cis_ubuntu2204_users_with_home.stdout_lines }}"
    - name: "SECTION1 | 1.7.4 | Ensure GDM screen locks when the user is idle | set gsettings set session idle-delay per user"
      become: true
      become_user: "{{ item }}"
      ansible.builtin.command: "dbus-run-session -- gsettings set org.gnome.desktop.session idle-delay {{ cis_ubuntu2204_rule_gdm_idle_delay }}"
      register: cis_ubuntu2204_session_idle_delay
      changed_when: cis_ubuntu2204_session_idle_delay.rc == 0
      failed_when: false
      loop: "{{ cis_ubuntu2204_users_with_home.stdout_lines }}"

- name: "SECTION1 | 1.7.5 | Ensure GDM screen locks cannot be overridden"
  ansible.builtin.template:
    src: gdm/00-screensaver-locks.j2
    dest: /etc/dconf/db/local.d/locks/00-screensaver
    owner: "{{ cis_ubuntu2204_section1_owner_default }}"
    group: "{{ cis_ubuntu2204_section1_group_default }}"
    mode: "{{ cis_ubuntu2204_section1_mode_default }}"
  when:
    - service_status_gdm3.stdout in ('loadedactive','loadedinactive')
    - cis_ubuntu2204_allow_gdm_gui
    - cis_ubuntu2204_rule_1_7_5
  notify: Update dconf
  tags:
    - rule_1_7
    - server_l1
    - workstation_l1

- name: "SECTION1 | 1.7.6 | Ensure GDM automatic mounting of removable media is disabled"
  when:
    - not cis_ubuntu2204_allow_autofs
    - service_status_gdm3.stdout in ('loadedactive','loadedinactive')
    - cis_ubuntu2204_allow_gdm_gui
    - cis_ubuntu2204_rule_1_7_6
  notify: Update dconf
  tags:
    - rule_1_7
    - server_l1
    - workstation_l2
  block:
    - name: "SECTION1 | 1.7.6 | Ensure GDM automatic mounting of removable media is disabled"
      ansible.builtin.template:
        src: gdm/00-media-automount.j2
        dest: /etc/dconf/db/local.d/00-media-automount
        owner: "{{ cis_ubuntu2204_section1_owner_default }}"
        group: "{{ cis_ubuntu2204_section1_group_default }}"
        mode: "{{ cis_ubuntu2204_section1_mode_default }}"
    - name: "SECTION1 | 1.7.6 | Ensure GDM automatic mounting of removable media is disabled | set gsettings disable automount per user"
      become: true
      become_user: "{{ item }}"
      ansible.builtin.command: "dbus-run-session -- gsettings set org.gnome.desktop.media-handling automount false"
      register: cis_ubuntu2204_disable_automount
      changed_when: cis_ubuntu2204_disable_automount.rc == 0
      failed_when: false
      loop: "{{ cis_ubuntu2204_users_with_home.stdout_lines }}"
    - name: "SECTION1 | 1.7.6 | Ensure GDM automatic mounting of removable media is disabled | set gsettings disable automount-open per user"
      become: true
      become_user: "{{ item }}"
      ansible.builtin.command: "dbus-run-session -- gsettings set org.gnome.desktop.media-handling automount-open false"
      register: cis_ubuntu2204_disable_automount_open
      changed_when: cis_ubuntu2204_disable_automount_open.rc == 0
      failed_when: false
      loop: "{{ cis_ubuntu2204_users_with_home.stdout_lines }}"

- name: "SECTION1 | 1.7.7 | Ensure GDM disabling automatic mounting of removable media is not overridden"
  ansible.builtin.template:
    src: gdm/00-media-automount-locks.j2
    dest: /etc/dconf/db/local.d/locks/00-media-automount
    owner: "{{ cis_ubuntu2204_section1_owner_default }}"
    group: "{{ cis_ubuntu2204_section1_group_default }}"
    mode: "{{ cis_ubuntu2204_section1_mode_default }}"
  when:
    - not cis_ubuntu2204_allow_autofs
    - service_status_gdm3.stdout in ('loadedactive','loadedinactive')
    - cis_ubuntu2204_allow_gdm_gui
    - cis_ubuntu2204_rule_1_7_7
  notify: Update dconf
  tags:
    - rule_1_7
    - server_l1
    - workstation_l2

- name: "SECTION1 | 1.7.8 | Ensure GDM autorun-never is enabled"
  when:
    - service_status_gdm3.stdout in ('loadedactive','loadedinactive')
    - cis_ubuntu2204_allow_gdm_gui
    - cis_ubuntu2204_rule_1_7_8
  notify: Update dconf
  tags:
    - rule_1_7
    - server_l1
    - workstation_l1
  block:
    - name: "SECTION1 | 1.7.8 | Ensure GDM autorun-never is enabled"
      ansible.builtin.template:
        src: gdm/00-media-autorun.j2
        dest: /etc/dconf/db/local.d/00-media-autorun
        owner: "{{ cis_ubuntu2204_section1_owner_default }}"
        group: "{{ cis_ubuntu2204_section1_group_default }}"
        mode: "{{ cis_ubuntu2204_section1_mode_default }}"
    - name: "SECTION1 | 1.7.8 | Ensure GDM autorun-never is enabled | set gsettings enable autorun-never per user"
      become: true
      become_user: "{{ item }}"
      ansible.builtin.command: "dbus-run-session -- gsettings set org.gnome.desktop.media-handling autorun-never true"
      register: cis_ubuntu2204_enable_autorun_never
      changed_when: cis_ubuntu2204_enable_autorun_never.rc == 0
      failed_when: false
      loop: "{{ cis_ubuntu2204_users_with_home.stdout_lines }}"

- name: "SECTION1 | 1.7.9 | Ensure GDM autorun-never is not overridden"
  ansible.builtin.template:
    src: gdm/00-media-autorun-locks.j2
    dest: /etc/dconf/db/local.d/locks/00-media-autorun
    owner: "{{ cis_ubuntu2204_section1_owner_default }}"
    group: "{{ cis_ubuntu2204_section1_group_default }}"
    mode: "{{ cis_ubuntu2204_section1_mode_default }}"
  when:
    - service_status_gdm3.stdout in ('loadedactive','loadedinactive')
    - cis_ubuntu2204_allow_gdm_gui
    - cis_ubuntu2204_rule_1_7_9
  notify: Update dconf
  tags:
    - rule_1_7
    - server_l1
    - workstation_l1

- name: "SECTION1 | 1.7.10 | Ensure XDCMP is not enabled"
  ansible.builtin.template:
    src: gdm/custom.conf.j2
    dest: /etc/gdm3/custom.conf
    owner: "{{ cis_ubuntu2204_section1_owner_default }}"
    group: "{{ cis_ubuntu2204_section1_group_default }}"
    mode: "{{ cis_ubuntu2204_section1_mode_default }}"
  when:
    - service_status_gdm3.stdout in ('loadedactive','loadedinactive')
    - cis_ubuntu2204_allow_gdm_gui
    - cis_ubuntu2204_rule_1_7_10
  tags:
    - rule_1_7
    - server_l1
    - workstation_l1

- name: "SECTION1 | 1.7.11 | Ensure Xwayland is configured"
  ansible.builtin.template:
    src: gdm/custom.conf.j2
    dest: /etc/gdm3/custom.conf
    owner: "{{ cis_ubuntu2204_section1_owner_default }}"
    group: "{{ cis_ubuntu2204_section1_group_default }}"
    mode: "{{ cis_ubuntu2204_section1_mode_default }}"
  when:
    - service_status_gdm3.stdout in ('loadedactive','loadedinactive')
    - cis_ubuntu2204_allow_gdm_gui
    - cis_ubuntu2204_rule_1_7_11
  tags:
    - rule_1_7
    - server_l1
    - workstation_l1
